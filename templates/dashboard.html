{% extends 'base.html' %}
{% block body %}

{% if services_active %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <div class="max-w-sm w-full bg-white rounded-lg shadow dark:bg-gray-800 p-4 md:p-6">
            <div class="flex justify-between">
                <div>
                    <h5 id="total-attacks-stat" class="leading-none text-3xl font-bold text-gray-900 dark:text-white pb-2">{{ total_attacks | default:"0" }}</h5>
                    <p class="text-base font-normal text-gray-500 dark:text-gray-400">Attacks on Active Services</p>
                </div>
            </div>
        </div>
        <div class="max-w-sm w-full bg-white rounded-lg shadow dark:bg-gray-800 p-4 md:p-6">
            <div class="flex justify-between">
                <div>
                    <h5 id="unique-attackers-stat" class="leading-none text-3xl font-bold text-gray-900 dark:text-white pb-2">{{ unique_attackers | default:"0" }}</h5>
                    <p class="text-base font-normal text-gray-500 dark:text-gray-400">Unique Attackers (IPs)</p>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow dark:bg-gray-800 p-4 md:p-6 mb-6">
        <h5 class="text-xl font-bold leading-none text-gray-900 dark:text-white me-1 mb-2">Live Attack Map</h5>
        <div id="attackMapId" style="height: 400px; border-radius: 8px;"></div>
    </div>
    <div class="bg-white rounded-lg shadow dark:bg-gray-800 p-4 md:p-6 mb-6">
        <h5 class="text-xl font-bold leading-none text-gray-900 dark:text-white me-1">Live Attack Analysis</h5>
        <div id="bar-chart"></div>
    </div>

    <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
        <h5 class="text-xl font-bold leading-none text-gray-900 dark:text-white p-4">Recent Activity (Live)</h5>
        <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-6 py-3">Timestamp</th>
                    <th scope="col" class="px-6 py-3">Source</th>
                    <th scope="col" class="px-6 py-3">IP Address</th>
                    <th scope="col" class="px-6 py-3">Location</th>
                    <th scope="col" class="px-6 py-3">Attack Type</th>
                </tr>
            </thead>
            <tbody id="attack-table-body">
                {% for attack in latest_attacks %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600" data-id="{{ attack.id }}">
                    <td class="px-6 py-4">{{ attack.timestamp }}</td>
                    <td class="px-6 py-4">{{ attack.get_source_display }}</td>
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">{{ attack.ip_address }}</td>
                    <td class="px-6 py-4">{{ attack.location }}</td>
                    <td class="px-6 py-4">{{ attack.get_attack_type_display }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div id="no-attacks-message" class="px-6 py-4 text-center text-gray-500 {% if latest_attacks %}hidden{% endif %}">
            Listening for new attacks...
        </div>
    </div>

{% else %}
    <div class="text-center bg-white dark:bg-gray-800 p-10 rounded-lg">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.016h-.008v-.016z" />
        </svg>
        <h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-white">No Active Honeypots</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Please start a service to begin monitoring for attacks.</p>
        <div class="mt-6">
            <a href="{% url 'setup' %}" class="inline-flex items-center rounded-md bg-indigo-600 px-3.5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                Go to Setup Page
            </a>
        </div>
    </div>
{% endif %}

<script>
    // This script only runs if services are active
    {% if services_active %}
    let latestAttackId = 0;
    let chart; // Keep a reference to the chart object
    let map; // Reference to the Leaflet map object
    let markers = []; // Array to keep track of map markers

    // --- Function to initialize the Leaflet map ---
    function initializeMap() {
        // Check if Leaflet library is loaded
        if (typeof L === 'undefined') {
            console.error("Leaflet library not loaded.");
            return;
        }
        // Check if the map container exists
        const mapContainer = document.getElementById('attackMapId');
        if (!mapContainer) {
            console.error("Map container 'attackMapId' not found.");
            return;
        }
        try {
            // Create a map centered roughly in the middle of the world
            map = L.map('attackMapId').setView([20, 0], 2); // Center: [latitude, longitude], Zoom level

            // Add a base map layer (tiles) from OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18, // Adjusted maxZoom for typical use
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        } catch (error) {
            console.error("Error initializing Leaflet map:", error);
        }
    }
    // ----------------------------------------------------

    // Function to fetch new attacks from our API
    async function fetchNewAttacks() {
        // Make sure map initialization succeeded before fetching
        if (typeof L === 'undefined' || !document.getElementById('attackMapId')) {
            return;
        }
        try {
            const response = await fetch(`{% url 'get-new-attacks-api' %}?latest_id=${latestAttackId}`);
            if (!response.ok) {
                console.error("Failed to fetch new attacks:", response.statusText);
                return; // Stop if the fetch failed
            }
            const result = await response.json();
            const newAttacks = result.attacks;

            if (newAttacks.length > 0) {
                const tableBody = document.getElementById('attack-table-body');
                const noAttacksMessage = document.getElementById('no-attacks-message');
                if(noAttacksMessage) noAttacksMessage.classList.add('hidden');

                // Update latestAttackId with the newest attack from this batch
                latestAttackId = newAttacks[0].id;

                newAttacks.forEach(attack => {
                    // --- Add row to the table (Existing code) ---
                    const newRow = document.createElement('tr');
                    newRow.className = 'bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600';
                    newRow.setAttribute('data-id', attack.id);
                    const timestamp = new Date(attack.timestamp).toLocaleString();
                    newRow.innerHTML = `
                        <td class="px-6 py-4">${timestamp}</td>
                        <td class="px-6 py-4">${attack.source_display}</td>
                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${attack.ip_address}</td>
                        <td class="px-6 py-4">${attack.location}</td>
                        <td class="px-6 py-4">${attack.attack_type_display}</td>
                    `;
                    tableBody.prepend(newRow);

                    // --- NEW: Add marker to the map ---
                    if (map && attack.latitude != null && attack.longitude != null) { // Check for null specifically
                        try {
                            const marker = L.marker([attack.latitude, attack.longitude]).addTo(map);

                            // Add a popup to the marker
                            marker.bindPopup(`<b>${attack.attack_type_display || 'Attack'}</b><br>${attack.ip_address || 'Unknown IP'}<br>${attack.location || 'Unknown Location'}`).openPopup();
                            markers.push(marker); // Add to our list

                            // Optional: Remove the oldest marker if we have too many
                            if (markers.length > 20) { // Keep the latest 20 markers
                                const oldMarker = markers.shift(); // Remove from beginning of array
                                map.removeLayer(oldMarker); // Remove from map
                            }

                            // Briefly pan the map to the new attack
                            map.panTo([attack.latitude, attack.longitude]);
                        } catch (markerError) {
                            console.error("Error adding marker:", markerError, "Attack data:", attack);
                        }
                    }
                    // ------------------------------------
                });

                // Limit the table rows (Existing code)
                while (tableBody.rows.length > 50) {
                    tableBody.deleteRow(-1);
                }
            }
        } catch (error) {
            console.error("Error fetching or processing new attacks:", error);
        }
    }

    // Function to update the chart and stats (Existing code)
    async function updateDashboardData() {
        try {
            const response = await fetch("{% url 'attack-data-api' %}");
             if (!response.ok) return;
            const chartData = await response.json();
            if (chart && chartData.labels && chartData.data) {
                // Ensure chart library is ready and chart object exists
                if (chart.updateSeries) {
                    chart.updateSeries([{ data: chartData.data }]);
                }
                if (chart.updateOptions) {
                    chart.updateOptions({ xaxis: { categories: chartData.labels } });
                }
            }
            // Update stats (example, requires fetching counts via API or estimating)
             const totalAttacksElem = document.getElementById('total-attacks-stat');
             if (totalAttacksElem) {
                 // Fetching actual count is better if you create an API endpoint for it
             }

        } catch (error) {
            console.error("Error updating chart data:", error);
        }
    }

    // This runs when the page is fully loaded
    window.addEventListener("load", async function () {
        // --- Initialize the map FIRST ---
        initializeMap();
        // -----------------------------

        const firstRow = document.querySelector('#attack-table-body tr');
        if (firstRow) {
            latestAttackId = parseInt(firstRow.getAttribute('data-id')) || 0;
        }

        // Fetch new attacks every 2.5 seconds
        setInterval(fetchNewAttacks, 2500);

        // Update the chart every 10 seconds
        setInterval(updateDashboardData, 10000);

        // Initial Chart Drawing (Existing code)
        try {
            const chartResponse = await fetch("{% url 'attack-data-api' %}");
            if (!chartResponse.ok) return;
            const chartData = await chartResponse.json();

            if (chartData.labels && chartData.labels.length > 0) {
                 const options = { series: [{ name: "Attacks", data: chartData.data }], chart: { type: 'bar', height: 350, toolbar: { show: false } }, plotOptions: { bar: { horizontal: false, columnWidth: '55%', borderRadius: 4 } }, dataLabels: { enabled: false }, xaxis: { categories: chartData.labels, labels: { style: { colors: '#9CA3AF', fontSize: '12px' } } }, yaxis: { title: { text: 'Number of Attacks', style: { color: '#9CA3AF' } }, labels: { style: { colors: '#9CA3AF', fontSize: '12px' } } }, fill: { opacity: 1 }, tooltip: { y: { formatter: (val) => val + " attacks" } } };
                 const chartElement = document.getElementById("bar-chart");
                 if (chartElement && typeof ApexCharts !== 'undefined') {
                     chart = new ApexCharts(chartElement, options);
                     chart.render();
                 } else {
                     console.error("Chart element or ApexCharts library not found for initial draw.");
                 }
            }
        } catch(error) {
             console.error("Error during initial chart draw:", error);
        }
    });
    {% endif %}
</script>

{% endblock %}